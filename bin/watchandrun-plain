#!/usr/bin/env bash

ppath="$1"
shift

mt="$(mktemp)"
chmod +x "$mt"
trap "rm $mt" EXIT

running=0

inotifywait -q -m -r --format '%w%f' -e modify "$ppath" \
	| while read -r file; do

	if [[ $file =~ .swp$ ]]; then
		continue
	fi
	if [[ $running -ne 0 ]]; then
		continue
	fi
	running=1

	(
	cp "$file" "$mt"
	clear

	cmdl="$(printf '%s ' $@)"

	echo "Date:    $(date --iso-8601=seconds)"
	echo "File:    $file"
	echo "Temp:    $mt"
	echo "Command: ${cmdl}"
	echo
	$cmdl
	)&
	wait

	running=0
done

