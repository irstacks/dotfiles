#!/usr/bin/env bash

ppath="$1"
shift

pushd $ppath

onexit(){
	popd
}
trap onexit EXIT

inotifywait -q -m -r --format '%w%f' -e modify "$ppath" \
	| while read -r file; do

	if [[ $file =~ .swp$ ]]; then
		continue
	fi
	if [[ $file =~ ~$ ]]; then
		continue
	fi

	clear

	cmdl="$(printf '%s ' $@)"
	cmdl="${cmdl//\%f/$file}"

	echo "Date:    $(date --iso-8601=seconds)"
	echo "File:    $file"
	echo "Command: ${cmdl//%f/$file}"
	echo
	exec "$cmdl"
done

